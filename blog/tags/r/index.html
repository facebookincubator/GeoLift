<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">3 posts tagged with &quot;R&quot; | GeoLift</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://facebookincubator.github.io/GeoLift/blog/tags/r"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;R&quot; | GeoLift"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/GeoLift/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://facebookincubator.github.io/GeoLift/blog/tags/r"><link data-rh="true" rel="alternate" href="https://facebookincubator.github.io/GeoLift/blog/tags/r" hreflang="en"><link data-rh="true" rel="alternate" href="https://facebookincubator.github.io/GeoLift/blog/tags/r" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/GeoLift/blog/rss.xml" title="GeoLift RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/GeoLift/blog/atom.xml" title="GeoLift Atom Feed"><link rel="stylesheet" href="/GeoLift/assets/css/styles.f459873d.css">
<link rel="preload" href="/GeoLift/assets/js/runtime~main.acd5815d.js" as="script">
<link rel="preload" href="/GeoLift/assets/js/main.114a354e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/GeoLift/"><div class="navbar__logo"><img src="/GeoLift/img/logo.svg" alt="GeoLift Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/GeoLift/img/logo.svg" alt="GeoLift Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">GeoLift</b></a><a class="navbar__item navbar__link" href="/GeoLift/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/GeoLift/docs/GettingStarted/Walkthrough">Walkthroughs</a><a class="navbar__item navbar__link" href="/GeoLift/Successes">Success Cases</a><a class="navbar__item navbar__link" href="/GeoLift/docs/About">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/GeoLift/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/GeoLift/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/continuous_geolifts">Continuous GeoLifts - Need For Speed</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/lookback_window">Enter into the time capsule - Determining Lookback Window</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/Python">Introducing GeoLift in Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/MultiCell">Multi-Cell Experiments with GeoLift</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/LaggedEffects">Measuring Lagged Effects using GeoLift</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/blueprint-geolift">GeoLift Blueprint Course by Meta</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/inverse-geolift">Inverse GeoLift - inference done cheaper</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/geolift-v23">Launching GeoLift v2.3 - Streamlined and Improved Power Calculations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/geo-measurement-review">A Brief Review of Geo Measurement Approaches</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/GeoLift/blog/welcome">Welcome</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;R&quot;</h1><a href="/GeoLift/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/GeoLift/blog/continuous_geolifts">Continuous GeoLifts - Need For Speed</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-28T00:00:00.000Z" itemprop="datePublished">April 28, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/NicolasMatrices-v2" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/NicolasMatrices-v2.png" alt="Nicolas Cruces"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/NicolasMatrices-v2" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Nicolas Cruces</span></a></div><small class="avatar__subtitle" itemprop="description">Marketing Science @ Meta | GeoLift Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">TL;DR<a class="hash-link" href="#tldr" title="Direct link to heading">​</a></h2><ul><li>This blog post demonstrates how to deal with treated observations in sequential GeoLift testing.</li><li>Currently, when running two sequential GeoLifts, the treatment period of the first experiment becomes part of the pre-treatment period of the second experiment, potentially affecting results and power calculations.</li><li>To prevent this, you can replace the treatment locations in the first experiment with the best counterfactual available. Once the treatment location has been replaced, make sure to expand the control donor pool with said series.</li><li>We introduce our <code>ReplaceTreatmentSplit</code> function to replace the treated location units, easily implementing our proposed solution.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>Advertisers have many questions to answer like, “What’s the incremental impact of this media channel?” and “What’s the budget elasticity of my investment in this channel?”.  These questions and more can be answered using GeoLift.</p><p>Since each question is different and we cannot answer them all at the same time, we need to decide which of them we should answer first by building a learning agenda. Our agenda holds everything from business questions and hypotheses to specific experiment designs that will give us the answers we are looking for. For the sake of simplicity, imagine we have two business questions, and we run our first GeoLift (experiment 1) to answer the first one and would like to design a new GeoLift (experiment 2) to give an answer to our second inquiry.</p><p>However, running a second GeoLift immediately after the previous one is not that simple.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sequential-geolift-testing">Sequential GeoLift testing<a class="hash-link" href="#sequential-geolift-testing" title="Direct link to heading">​</a></h2><p>At a first glance, we have a couple of options:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-1-repeating-our-experiment-1-treatment-group-in-experiment-2-excluding-the-experiment-1-periods">Option 1: Repeating our experiment 1 treatment group in experiment 2, excluding the experiment 1 periods.<a class="hash-link" href="#option-1-repeating-our-experiment-1-treatment-group-in-experiment-2-excluding-the-experiment-1-periods" title="Direct link to heading">​</a></h4><p>This implies that we will remove experiment 1 time periods from the pre-treatment period, meaning we will get the same time series we had before experiment 1 was run. Furthermore, if we rerun the power analysis with this series, we will get the same treatment group we had for experiment 1.</p><p>While an attractive option, it lacks flexibility due to the fact that we will probably choose the same treatment we did before experiment 1. Furthermore, we should make sure that the GeoLift model is able to accurately predict the most recent time-stamps, using the latest market dynamics. For example, if we had a test for all of December, then the model trained up to November might struggle to predict January due to different spending trends. Moreover, if the treatment was very long, this might make it very hard to justify tying the set of pre-treatment periods for experiment 1 to the periods during experiment 2.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-2-rerunning-the-power-analysis-for-experiment-2-without-excluding-experiment-1-periods">Option 2: Rerunning the power analysis for experiment 2, without excluding experiment 1 periods.<a class="hash-link" href="#option-2-rerunning-the-power-analysis-for-experiment-2-without-excluding-experiment-1-periods" title="Direct link to heading">​</a></h4><p>Without removing the periods from experiment 1, we will preserve the autocorrelation within the time series and avoid the sudden change that may occur, while keeping the latest time-stamps. Having said this, going with this option poses another threat. Locations that were used as a treatment group in experiment 1 will probably not be chosen as a good setup in the GeoLift ranking algorithm. When we run simulations using those locations, the simulated effect will probably be far off from the observed effect, since they already had a previous treatment that we are not considering.</p><p>If the locations selected as the treatment group presented a good setup for experiment 1, then at least some of them should be selected to be part of the treatment of experiment 2.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="our-solution-replace-treatment-group-values-from-experiment-1">Our solution: Replace treatment group values from experiment 1<a class="hash-link" href="#our-solution-replace-treatment-group-values-from-experiment-1" title="Direct link to heading">​</a></h3><p>Our goal is maximizing the amount of data we have without excluding any periods and guaranteeing that our dataset does not contain any structural changes (treatment applied to certain locations in experiment 1). To do so, we recommend replacing the values of the locations that were treated during experiment 1, during the periods in which the treatment occurred and including them in the control donor pool.  For reference, here’s a picture of what this looks like.</p><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/continuous_gl-plot2.png?raw=true" alt="continuous_geolift1" class="img_ev3q"></p><p>Here’s an example of our <strong>pseudo-code</strong>:</p><ol><li>Define locations that were treated and treatment period during experiment 1.</li><li>Fit a GeoLift counterfactual to each of the treatment locations, training it on experiment 1’s pre-treatment period.</li><li>Only keep the counterfactual that has the closest match to a treatment location in the pre-treatment period (using <strong>absolute L2 imbalance</strong>, A.K.A. the sum of squared differences between treatment and control prior to the experiment).</li><li>Replace the selected treatment location by its counterfactual values during the experiment 1’s treatment period.</li><li>Reassign the replaced treatment location to the control donor pool.</li><li>Repeat this process until there are no more treatment locations left.</li></ol><p>This solution has three clear benefits:</p><ul><li>We preserve the time series structure without excluding any data.</li><li>We replace the structural change in the treatment locations by our best estimate of what would have happened if they had not been treated.</li><li>We have a higher chance of providing better counterfactual fits for the replaced treatments because we are enlarging the control donor pool with each replacement.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-driven-validation">Data-driven validation<a class="hash-link" href="#data-driven-validation" title="Direct link to heading">​</a></h2><p>The last of these benefits <strong>does not necessarily mean</strong> that we will always be better off.  Particularly, the algorithm will provide the same L2 imbalance values for cases where we have a smaller treatment size given that the added value of the replaced treatment to the control donor pool will not be as large.</p><p>In order to understand what was the average impact that our algorithm had on L2 imbalance, we decided to run a random selection of locations to build different treatment groups of 5 locations.  We then passed those random groups through the algorithm, and compared it to the L2 imbalance that the counterfactual would have if the replaced treatment had not been added to the control donor pool. That is what we call the L2 imbalance improvement ratio:</p><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/continuous_gl-plot3.png?raw=true" alt="continuous_geolift2" class="img_ev3q">
<img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/continuous_gl-plot1.png?raw=true" alt="continuous_geolift3" class="img_ev3q"></p><p>While the majority of the observations for the L2 imbalance improvement ratio are close to zero, there is a negative long tail that shows that there are some cases where our algorithm works better than the alternative.</p><p>To make our finding more robust, we repeated the simulations with randomly selected treatment groups of different sizes. Looking at the 10% and 25% quantiles of the histogram provided above for each treatment size, we saw improvements in L2 imbalance of up to 8% in the 10% quantile. Naturally, the larger the treatment group, the higher the benefit of our proposed solution, in line with our aforementioned hypothesis.</p><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/continuous_gl-table1.png?raw=true" alt="continuous_geolift4" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-implement-the-algorithm">How to implement the algorithm?<a class="hash-link" href="#how-to-implement-the-algorithm" title="Direct link to heading">​</a></h2><p>We have recently landed a simple method for you to use if you would like to leverage this algorithm. Simply implement the <code>ReplaceTreatmentSplit</code> function, specifying what the treatment locations and the treatment start date and end date for experiment 1 are. You can pick up the replaced dataset from the <code>$data</code> argument in the list. The <code>$l2_imbalance_df</code> will give you the data frame of L2 imbalances for each treatment location when they were replaced.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Import libraries and transform data.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">library(GeoLift)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data(GeoLift_Test)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">geo_data &lt;- GeoDataRead(data = GeoLift_Test,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        date_id = &quot;date&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        location_id = &quot;location&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        Y_id = &quot;Y&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        X = c(), #empty list as we have no covariates</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        format = &quot;yyyy-mm-dd&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        summary = TRUE)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">treatment_group &lt;- c(‘chicago’, ‘portland’)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Replace treatment locations for best counterfactual.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">g &lt;- ReplaceTreatmentSplit(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  treatment_locations = treatment_group,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  data = geo_data,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  treatment_start_time = 90,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  treatment_end_time = 105,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  model = &quot;none&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  verbose = TRUE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Extract replaced data.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">new_geo_data &lt;- g$data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-up-next">What’s up next?<a class="hash-link" href="#whats-up-next" title="Direct link to heading">​</a></h2><p>Keep your eye out for our coming blog posts, around topics like:</p><ul><li>When should I use Fixed Effects to get a higher signal to noise ratio?</li><li>Long term branding measurement with GeoLift.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-lift">GeoLift</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-measurement">Geo Measurement</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/continuous-lift">continuous lift</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/r">R</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/power-analysis">Power Analysis</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/GeoLift/blog/lookback_window">Enter into the time capsule - Determining Lookback Window</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-02-09T00:00:00.000Z" itemprop="datePublished">February 9, 2023</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/NicolasMatrices-v2" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/NicolasMatrices-v2.png" alt="Nicolas Cruces"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/NicolasMatrices-v2" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Nicolas Cruces</span></a></div><small class="avatar__subtitle" itemprop="description">Marketing Science @ Meta | GeoLift Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em><div align="right">“Aunque me fuercen yo nunca voy a decir</div></em>
<em><div align="right">Que todo tiempo, por pasado fue mejor&quot;</div></em>
<em><div align="right"> - Luis Alberto Spinetta</div></em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">TL;DR<a class="hash-link" href="#tldr" title="Direct link to heading">​</a></h2><ul><li>The success of a geo-based experiment greatly depends on the Market Selection process.</li><li>In the GeoLift package, we use historical data and a simulation-based approach to identify the best set of treatment and control locations based on the constraints specified by the user.</li><li>Selecting an appropriate value for the <code>lookback_window</code> parameter (the amount of pre-treatment periods that will be considered) is a very important part of the process.</li><li>Based on the analysis presented in this note, we generally recommend using <strong>1/10th of the pre-treatment period as a simulation <code>lookback_window</code></strong> (especially if your time-series has a lot of variability across time).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-considered-a-simulation-in-geolift">What is considered a simulation in GeoLift?<a class="hash-link" href="#what-is-considered-a-simulation-in-geolift" title="Direct link to heading">​</a></h2><p>Essentially, before running the actual test, we are running a series of geo experiments to determine which is the best setup that will pave the way to success. As explained in further detail in <a href="https://www.facebookblueprint.com/student/path/253063" target="_blank" rel="noopener noreferrer">our Blueprint Course</a>, the GeoLift Market Selection process simulates a large number of geo experiments to determine which is the best test and control setup for you.</p><p>In each simulation a <strong>treatment effect</strong> is applied over a <strong>treatment group</strong> during the <strong>treatment period</strong>. Then, GeoLift then trains a <strong>counterfactual</strong> for the treatment group by using all of <strong>the pre-treatment periods</strong> prior to the experiment to assess the model&#x27;s performance.  Let’s breakdown each of these five components:</p><ul><li><strong>The treatment effect</strong>: is the Lift percentage that will be applied to a set of locations during the testing period.</li><li><strong>The treatment group</strong>: these are a set of locations that will be exposed to the treatment effect.</li><li><strong>The counterfactual</strong>: these are a set of locations that are used to estimate what would have happened to the treatment group if it had not been exposed to the treatment effect.  An easy way to think about it is as a weighted average of all the locations that are not part of the treatment group.</li><li><strong>The treatment period</strong>: represents the moments in which the treatment group will be exposed to the treatment.</li><li><strong>The pre-treatment period</strong>: this refers to the amount of periods that will be used to build the counterfactual, where there was no simulated difference between locations.  During this period, the counterfactual and the treatment group should have a similar behavior.</li></ul><p>Applying different effects to the same group in the same period allows us to holistically determine what the Minimum Detectable Effect (MDE) for that setup will be.  Among other metrics, this helps us understand whether we are dealing with a combination of locations that will have a higher likelihood of observing small effect sizes. However, seasonalities and variations throughout time make can difficult to estimate the MDE with complete certainty.  Fortunately, we can reduce this uncertainty by taking a look at the past!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-the-lookback-window-parameter">Introducing the lookback window parameter.<a class="hash-link" href="#introducing-the-lookback-window-parameter" title="Direct link to heading">​</a></h2><p>Our first simulation uses the most recent/latest periods in our series as our <strong>treatment period</strong> and all of the remaining periods as our <strong>pre-treatment period</strong>.  This gives us the metrics we need to rank treatment groups for those time periods.</p><p>As stated in our <a href="https://facebookincubator.github.io/GeoLift/docs/GettingStarted/Walkthrough" target="_blank" rel="noopener noreferrer">GeoLift Walkthrough</a>, we can increase the number of simulated time periods by changing the <code>lookback_window</code>.  The <code>lookback_window</code> indicates how far back in time the simulations for the power analysis will go.  By increasing the <code>lookback_window</code>, we subtract the last period from the previous simulation’s total duration and repeat the process over the remaining periods.  Finally, we calculate the average metrics for each treatment group over all of the runs in different periods.</p><p>For example, imagine we have a 90 day long series with different locations and we would like to simulate a 15 day test, with a 2 day <code>lookback_window</code>.</p><ul><li>In the first simulation, the <strong>treatment period</strong> is made up of the most recent dates and Lift is simulated on it.  The remainder, the <strong>pre-treatment period</strong>, is used to build a counterfactual.  So, with a test duration of 15 days, for this iteration we use periods 1 to 75 as a <strong>pre-treatment period</strong> and periods 76 to 90 as a <strong>treatment period</strong>.</li><li>For our second simulation, the treatment period is shifted by one timestamp.  We use periods 1 to 74 as a pre-treatment period and periods 75 to 89 as a <strong>treatment period</strong>.</li><li>We then construct average metrics per each <strong>treatment group</strong>, using these two simulations.  In essence, we are repeating this flow until the number of time periods shifted is equal to the <code>lookback_window</code> parameter.</li></ul><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/lookback_1.png?raw=true" alt="lookbackwindow" class="img_ev3q"></p><p>In this context, more simulations allow us to have a more robust estimate of the metrics for each <strong>treatment group</strong>, observing if the same behavior occurs across different simulated <strong>treatment</strong> and <strong>pre-treatment periods</strong>.  The intuitive idea here is that we would like to capture some of the variability in the time series in our test setups, to avoid assuming something that could be different in the future.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="theres-a-tradeoff-robustness-vs-preciseness">There’s a tradeoff: robustness vs preciseness<a class="hash-link" href="#theres-a-tradeoff-robustness-vs-preciseness" title="Direct link to heading">​</a></h2><p>The more we look back into the past, the more simulations per <strong>treatment group</strong> we will have.  This will make our estimates more robust and allow us to make safer predictions with regard to the pre-test metrics.</p><p>However, the more we look back into the past, the less precise our simulation will be as compared to the actual result.  Removing the last periods we have prior to the test leads to two major effects:</p><ul><li>Our simulations become less precise because they have a smaller amount of periods to build the counterfactual than what the actual experiment will have.</li><li>The accuracy of our simulation will be reduced since we are shortening the time that is being considered by the algorithm’s pre-treatment period.</li></ul><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/lookback_2.png?raw=true" alt="lookback_tradeoff" class="img_ev3q"></p><p>Given this tradeoff, we need to choose the amount of simulations we run considering the potential they have but keeping in mind that they also have a downside. Moreover, it is important to note that incresing the <code>lookback_window</code> parameter will exponentially increase the number of simulations performed in the Market Selection algorithm and will result in a longer runtime.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-choose-the-best-lookback_window">How to choose the best <code>lookback_window</code>?<a class="hash-link" href="#how-to-choose-the-best-lookback_window" title="Direct link to heading">​</a></h2><p>The best way to analyze this problem is to capture the variance of detected effects in the same simulated <strong>treatment period</strong> for different <strong>treatment group</strong> combinations.</p><p>We have run this analysis using the dummy dataset that is available within the GeoLift package (<code>data(GeoLift_PreTest)</code>).  This dataset is similar to the example we showed above: it has a total of 90 days of pre-experiment data, and we will simulate a test that will last 15 days.  If we assume that there was no preexisting difference between locations, then the median of detected effects for each test start period should be around zero, which is the true effect.</p><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/lookback_3.png?raw=true" alt="Simulations_lookback" class="img_ev3q"></p><p><em>The plot on the left shows the standard deviation of the detected effect per treatment start period. The plot on the right shows the range of detected effects for different treatment groups.</em></p><p>As we can see from the plot in the left, the standard deviation of the detected effect has a continuous drop from period 67 onwards.  From the second plot, we can also observe that the median effect is close to zero, especially in the last periods.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-in-practice">Putting it in practice<a class="hash-link" href="#putting-it-in-practice" title="Direct link to heading">​</a></h2><p>Since we have 75 pre-treatment periods in total, and the drop in standard deviation occurs in period 67, we would set a <code>lookback_window</code> of 8 periods.</p><p>To be as efficient as possible, we suggest running the GeoLiftMarketSelection function to find the best combination of markets with a <code>lookback_window=1</code>.  With those best candidates, do a deep dive with a longer <code>lookback_window=8</code> for each treatment combination by running GeoLiftPower, plot and analyze their power curves.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-conclusion">In conclusion<a class="hash-link" href="#in-conclusion" title="Direct link to heading">​</a></h2><p>The <code>lookback_window</code> parameter is a fundamental element of a robust Power Analysis and Market Selection. As a best practice, we recommend running a data-driven analysis similar to the one that was showcased here to identify the ideal value for this parameter. Alternatively, <strong>a great rule of thumb is to keep 1/10 of the pre-treatment periods for simulations, once the test duration has been defined</strong>. So, if you have a total of 150 periods before your experiment, and you want to run a 10 day test, a total of 140 pre-treatment periods would remain.  Following this rule, you would have to set a <code>lookback_window=14</code> for the preferred options that come out of the GeoLiftMarketSelection ranking.</p><p>At the very least,  we suggest setting the <code>lookback_window</code> to a value that is at least as large as the time-series’ most granular seasonality (if we observe that sales vary widely throughout the days of the week, then setting the <code>lookback_window</code> to 7 would be a good start).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-up-next">What’s up next?<a class="hash-link" href="#whats-up-next" title="Direct link to heading">​</a></h2><p>Stay tuned for our next blog posts, related to topics like:</p><ul><li>When should I use Fixed Effects to get a higher signal to noise ratio?</li><li>When should our GeoLift test start?</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-lift">GeoLift</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-measurement">Geo Measurement</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/lookback-window">lookback_window</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/r">R</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/power-analysis">Power Analysis</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/GeoLift/blog/Python">Introducing GeoLift in Python</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-08-11T00:00:00.000Z" itemprop="datePublished">August 11, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/JussanN/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/JussanN.png" alt="Jussan Da Silva"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/JussanN/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jussan Da Silva</span></a></div><small class="avatar__subtitle" itemprop="description">Marketing Science @ Meta | GeoLift Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>Today we released a <a href="https://github.com/facebookincubator/GeoLift/tree/GeoLiftPython" target="_blank" rel="noopener noreferrer">tutorial</a> explaining how to run an end-to-end implementation of GeoLift in Python leveraging the <code>rpy2</code> package.  This has been a frequently requested feature by the GeoLift community. Moreover, it is one that we believe is very important for the continued scaling of GeoLift in data-savvy organizations.</p><p>The goal of this tutorial is to empower Python users to run the GeoLift R functions in Python using the <a href="https://rpy2.github.io" target="_blank" rel="noopener noreferrer"><code>rpy2</code></a> package. The rpy2 is an open source library which enables calling R from Python. It’s designed to facilitate the use of R by Python programmers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="geolift-in-python">GeoLift in Python<a class="hash-link" href="#geolift-in-python" title="Direct link to heading">​</a></h2><p>GeoLift is an end-to-end solution to measure Lift at a Geo-level using the latest developments in Synthetic Control Methods. Through this tutorial it is possible to run GeoLift R functions such as: Power Calculations, Inference, and Plots in Python.</p><p>There are 3 functions in Python under utils.py:</p><ul><li><p><code>GeoLiftData</code>: Load and return the dataset included in the GeoLift package.</p></li><li><p><code>ConvertDf</code>: Convert R dataframe into Pandas if <code>conv_type = &quot;ToPandas&quot;</code> or convert Pandas dataframe into R if <code>conv_type = &quot;ToR&quot;</code>.</p></li></ul><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/GeoLiftPython_1.jpg?raw=true" alt="ConvertDf" class="img_ev3q"></p><ul><li><code>GeoLiftPlot</code>: Receive a specific GeoLift Plot function (defined by the <code>func</code> parameter), its arguments and display the plot.</li></ul><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/GeoLiftPython_2.jpg?raw=true" alt="GeoLiftPlot" class="img_ev3q"></p><p>To run the R GeoLift functions in Python, you need to add <code>GeoLift.</code> in front of it as in <code>GeoLift.GeoLiftMarketSelection()</code>. For example:</p><p><img loading="lazy" src="https://github.com/facebookincubator/GeoLift/blob/main/website/static/img/GeoLiftPython_3.jpg?raw=true" alt="GeoLiftPython" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="start-your-geolift-in-python-now">Start Your GeoLift in Python Now!​<a class="hash-link" href="#start-your-geolift-in-python-now" title="Direct link to heading">​</a></h2><p>You can access the GeoLift in Python tutorial in the GeoLiftPython folder hosted in the GeoLift github repository through <a href="https://github.com/facebookincubator/GeoLift/tree/GeoLiftPython" target="_blank" rel="noopener noreferrer">this link</a>. The <code>README</code> file contains all the necessary information to start working with the Python version of GeoLift.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-lift">GeoLift</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/geo-measurement">Geo Measurement</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/python">Python</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/GeoLift/blog/tags/r">R</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/GeoLift/docs/intro">Documentation</a></li><li class="footer__item"><a href="https://www.facebookblueprint.com/student/path/253063-geolift-marketing-measurement?sid=cd9a46bc-9685-4af4-8ac3-4482e858fba9&amp;sid_i=5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blueprint Course<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/GeoLift/Successes">Success Cases</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/groups/fbgeolift" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCzkuhQFBCHz9TxzUXlNUINg" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/GeoLift/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/GeoLift/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/GeoLift/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/GeoLift/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright © 2023 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/GeoLift/assets/js/runtime~main.acd5815d.js"></script>
<script src="/GeoLift/assets/js/main.114a354e.js"></script>
</body>
</html>